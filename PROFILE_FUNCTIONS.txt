// ===== Profile Feature Functions =====
// Add these to your app.js

// Add to elements object:
/*
    profileBtn: document.getElementById('profileBtn'),
    profileModal: document.getElementById('profileModal'),
    closeProfileModal: document.getElementById('closeProfileModal'),
    profileView: document.getElementById('profileView'),
    profileEdit: document.getElementById('profileEdit'),
    profileAvatarDisplay: document.getElementById('profileAvatarDisplay'),
    profileAvatarImg: document.getElementById('profileAvatarImg'),
    profileAvatarEmoji: document.getElementById('profileAvatarEmoji'),
    profileDisplayName: document.getElementById('profileDisplayName'),
    profileAccountId: document.getElementById('profileAccountId'),
    profileFriendCount: document.getElementById('profileFriendCount'),
    profileBioText: document.getElementById('profileBioText'),
    editProfileBtn: document.getElementById('editProfileBtn'),
    avatarPreview: document.getElementById('avatarPreview'),
    avatarPreviewImg: document.getElementById('avatarPreviewImg'),
    avatarPreviewEmoji: document.getElementById('avatarPreviewEmoji'),
    avatarInput: document.getElementById('avatarInput'),
    uploadAvatarBtn: document.getElementById('uploadAvatarBtn'),
    removeAvatarBtn: document.getElementById('removeAvatarBtn'),
    editDisplayName: document.getElementById('editDisplayName'),
    editBio: document.getElementById('editBio'),
    bioCharCount: document.getElementById('bioCharCount'),
    cancelEditBtn: document.getElementById('cancelEditBtn'),
    saveProfileBtn: document.getElementById('saveProfileBtn')
*/

// Avatar state
let pendingAvatarData = null;

// Open Profile Modal
async function openProfileModal() {
    // Load current user data
    const userDoc = await db.collection('users').doc(APP_STATE.currentUser.uid).get();
    const userData = userDoc.data();
    
    // Update profile view
    elements.profileDisplayName.textContent = userData.displayName || userData.username;
    elements.profileAccountId.textContent = userData.accountId;
    
    // Display avatar
    if (userData.avatarImage) {
        elements.profileAvatarImg.src = userData.avatarImage;
        elements.profileAvatarImg.style.display = 'block';
        elements.profileAvatarEmoji.style.display = 'none';
    } else {
        elements.profileAvatarEmoji.textContent = userData.avatar || 'ðŸ‘¤';
        elements.profileAvatarImg.style.display = 'none';
        elements.profileAvatarEmoji.style.display = 'block';
    }
    
    // Display bio
    elements.profileBioText.textContent = userData.bio || 'ChÆ°a cÃ³ tiá»ƒu sá»­';
    
    // Get friend count
    const friendsSnapshot = await db.collection('users').doc(APP_STATE.currentUser.uid)
        .collection('friends').get();
    elements.profileFriendCount.textContent = friendsSnapshot.size;
    
    // Show modal
    openModal(elements.profileModal);
}

// Switch to Edit Mode
function switchToEditMode() {
    elements.profileView.style.display = 'none';
    elements.profileEdit.style.display = 'block';
    
    // Load current values
    elements.editDisplayName.value = APP_STATE.currentUser.displayName || '';
    elements.editBio.value = APP_STATE.currentUser.bio || '';
    updateBioCharCount();
    
    // Set avatar preview
    if (APP_STATE.currentUser.avatarImage) {
        elements.avatarPreviewImg.src = APP_STATE.currentUser.avatarImage;
        elements.avatarPreviewImg.style.display = 'block';
        elements.avatarPreviewEmoji.style.display = 'none';
        elements.removeAvatarBtn.style.display = 'inline-block';
    } else {
        elements.avatarPreviewEmoji.textContent = APP_STATE.currentUser.avatar || 'ðŸ‘¤';
        elements.avatarPreviewImg.style.display = 'none';
        elements.avatarPreviewEmoji.style.display = 'block';
        elements.removeAvatarBtn.style.display = 'none';
    }
}

// Cancel Edit - Back to View
function cancelEdit() {
    elements.profileEdit.style.display = 'none';
    elements.profileView.style.display = 'block';
    pendingAvatarData = null;
}

// Handle Avatar Upload
function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('Vui lÃ²ng chá»n file áº£nh!');
        return;
    }
    
    // Check file size (max 5MB before compression)
    if (file.size > 5 * 1024 * 1024) {
        alert('áº¢nh quÃ¡ lá»›n! Vui lÃ²ng chá»n áº£nh nhá» hÆ¡n 5MB.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            // Compress and resize to 200x200
            const canvas = document.createElement('canvas');
            const maxSize = 200;
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxSize) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width = (width / height) * maxSize;
                    height = maxSize;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to JPEG with 0.8 quality
            const compressedData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Store pending avatar data
            pendingAvatarData = compressedData;
            
            // Update preview
            elements.avatarPreviewImg.src = compressedData;
            elements.avatarPreviewImg.style.display = 'block';
            elements.avatarPreviewEmoji.style.display = 'none';
            elements.removeAvatarBtn.style.display = 'inline-block';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// Remove Avatar
function removeAvatar() {
    pendingAvatarData = 'removed';
    elements.avatarPreviewImg.style.display = 'none';
    elements.avatarPreviewEmoji.style.display = 'block';
    elements.avatarPreviewEmoji.textContent = getRandomAvatar();
    elements.removeAvatarBtn.style.display = 'none';
}

// Update Bio Character Count
function updateBioCharCount() {
    const length = elements.editBio.value.length;
    elements.bioCharCount.textContent = `${length}/150`;
}

// Save Profile
async function saveProfile() {
    const newDisplayName = elements.editDisplayName.value.trim();
    const newBio = elements.editBio.value.trim();
    
    // Validation
    if (!newDisplayName) {
        alert('Vui lÃ²ng nháº­p tÃªn hiá»ƒn thá»‹!');
        return;
    }
    
    if (newDisplayName.length > 30) {
        alert('TÃªn hiá»ƒn thá»‹ quÃ¡ dÃ i (tá»‘i Ä‘a 30 kÃ½ tá»±)!');
        return;
    }
    
    if (newBio.length > 150) {
        alert('Tiá»ƒu sá»­ quÃ¡ dÃ i (tá»‘i Ä‘a 150 kÃ½ tá»±)!');
        return;
    }
    
    try {
        const updateData = {
            displayName: newDisplayName,
            bio: newBio
        };
        
        // Handle avatar update
        if (pendingAvatarData === 'removed') {
            updateData.avatarImage = firebase.firestore.FieldValue.delete();
            updateData.avatar = getRandomAvatar();
        } else if (pendingAvatarData) {
            updateData.avatarImage = pendingAvatarData;
        }
        
        // Update Firestore
        await db.collection('users').doc(APP_STATE.currentUser.uid).update(updateData);
        
        // Update local state
        APP_STATE.currentUser.displayName = newDisplayName;
        APP_STATE.currentUser.bio = newBio;
        if (pendingAvatarData === 'removed') {
            delete APP_STATE.currentUser.avatarImage;
            APP_STATE.currentUser.avatar = updateData.avatar;
        } else if (pendingAvatarData) {
            APP_STATE.currentUser.avatarImage = pendingAvatarData;
        }
        
        // Reset pending avatar
        pendingAvatarData = null;
        
        // Reload profile view
        await openProfileModal();
        cancelEdit();
        
    } catch (error) {
        console.error('Save profile error:', error);
        alert('Lá»—i khi lÆ°u profile: ' + error.message);
    }
}

// Add Event Listeners (add to setupEventListeners function):
/*
    elements.profileBtn.addEventListener('click', openProfileModal);
    elements.closeProfileModal.addEventListener('click', () => closeModal(elements.profileModal));
    elements.editProfileBtn.addEventListener('click', switchToEditMode);
    elements.cancelEditBtn.addEventListener('click', cancelEdit);
    elements.uploadAvatarBtn.addEventListener('click', () => elements.avatarInput.click());
    elements.avatarInput.addEventListener('change', handleAvatarUpload);
    elements.removeAvatarBtn.addEventListener('click', removeAvatar);
    elements.editBio.addEventListener('input', updateBioCharCount);
    elements.saveProfileBtn.addEventListener('click', saveProfile);
    
    elements.profileModal.addEventListener('click', (e) => {
        if (e.target === elements.profileModal) closeModal(elements.profileModal);
    });
*/

// Update user registration to include bio field (in handleRegister function):
/*
    await db.collection('users').doc(user.uid).set({
        accountId: accountId,
        username: username.toLowerCase(),
        displayName: displayName,
        avatar: getRandomAvatar(),
        bio: '', // ADD THIS LINE
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        email: email
    });
*/
